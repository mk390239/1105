<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ç–‘ä¼¼6DoF ARä½“é¨“</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
    <a-scene 
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true"
    >
        
        <!-- å›ºå®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ« -->
        <a-entity
            id="fixed-model"
            gltf-model="4.glb"
            scale="0.01 0.01 0.01"
            position="0 0 -1"
        ></a-entity>
        
        <!-- ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã«é€£å‹•ã™ã‚‹ã‚«ãƒ¡ãƒ© -->
        <a-entity
            camera
            look-controls="enabled: false"
            wasd-controls="enabled: false"
            device-orientation-permission-ui
        ></a-entity>
        
    </a-scene>
    
    <!-- ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ -->
    <div id="start-button" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        <button style="padding: 20px 40px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 10px;">
            ğŸš€ ARä½“é¨“ã‚’é–‹å§‹
        </button>
    </div>

    <!-- æ“ä½œèª¬æ˜ -->
    <div style="position: absolute; bottom: 20px; left: 0; right: 0; text-align: center; color: white; font-family: 'Hiragino Sans', sans-serif;">
        <div style="background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; display: inline-block;">
            <div>ğŸ“± <b>ã‚¹ãƒãƒ›ã‚’å‹•ã‹ã—ã¦</b> ãƒ¢ãƒ‡ãƒ«ã‚’è¦‹ã¦å›ã‚Œã¾ã™</div>
            <div>ğŸ“ ãƒ¢ãƒ‡ãƒ«ã¯ç©ºé–“ã«å›ºå®šã•ã‚Œã¦ã„ã¾ã™</div>
        </div>
    </div>

    <script>
        // ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
        AFRAME.registerComponent('device-orientation-controls', {
            init: function() {
                this.camera = this.el;
                this.initialAlpha = null;
                this.isPermissionGranted = false;
                
                this.setupEventListeners();
            },
            
            setupEventListeners: function() {
                const startButton = document.getElementById('start-button');
                
                // ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³
                startButton.addEventListener('click', () => {
                    this.requestDeviceOrientation();
                    startButton.style.display = 'none';
                });
                
                // ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã®å¤‰æ›´ã‚’ç›£è¦–
                window.addEventListener('deviceorientation', (event) => {
                    if (!this.isPermissionGranted) return;
                    
                    if (this.initialAlpha === null) {
                        this.initialAlpha = event.alpha;
                    }
                    
                    // ã‚«ãƒ¡ãƒ©ã®å›è»¢ã‚’ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã«é€£å‹•
                    const alpha = event.alpha - this.initialAlpha;
                    const beta = event.beta;
                    const gamma = event.gamma;
                    
                    this.camera.setAttribute('rotation', {
                        x: beta - 90,   // ä¸Šä¸‹ã®å‚¾ã
                        y: 0,           // å·¦å³ã®å‘ã
                        z: -gamma       // å·¦å³ã®å‚¾ã
                    });
                });
            },
            
            requestDeviceOrientation: function() {
                if (typeof DeviceOrientationEvent !== 'undefined' && 
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS 13+
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                this.isPermissionGranted = true;
                                console.log('âœ… ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã®è¨±å¯ã‚’å¾—ã¾ã—ãŸ');
                            }
                        })
                        .catch(console.error);
                } else {
                    // Android ã‚„ãã®ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶
                    this.isPermissionGranted = true;
                    console.log('âœ… ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');
                }
            }
        });
        
        // ãƒ¢ãƒ‡ãƒ«æ“ä½œã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆæ‹¡å¤§ç¸®å°ãƒ»å›è»¢ï¼‰
        AFRAME.registerComponent('model-interaction', {
            init: function() {
                this.model = this.el;
                this.initialScale = 0.01;
                this.currentScale = this.initialScale;
                
                this.setupInteractions();
            },
            
            setupInteractions: function() {
                const scene = this.model.sceneEl;
                
                // ã‚¿ãƒƒãƒæ“ä½œ
                let isRotating = false;
                let lastTouchX = 0;
                let initialPinchDistance = 0;
                let initialScale = 0;
                
                scene.addEventListener('touchstart', (evt) => {
                    if (evt.touches.length === 1) {
                        isRotating = true;
                        lastTouchX = evt.touches[0].clientX;
                    }
                    
                    if (evt.touches.length === 2) {
                        initialPinchDistance = this.getTouchDistance(evt.touches);
                        initialScale = this.currentScale;
                    }
                });
                
                scene.addEventListener('touchmove', (evt) => {
                    evt.preventDefault();
                    
                    // å›è»¢
                    if (isRotating && evt.touches.length === 1) {
                        const deltaX = evt.touches[0].clientX - lastTouchX;
                        const currentRotation = this.model.getAttribute('rotation');
                        this.model.setAttribute('rotation', {
                            x: currentRotation.x,
                            y: currentRotation.y + deltaX * 0.5,
                            z: currentRotation.z
                        });
                        lastTouchX = evt.touches[0].clientX;
                    }
                    
                    // ã‚¹ã‚±ãƒ¼ãƒ«
                    if (evt.touches.length === 2) {
                        const currentDistance = this.getTouchDistance(evt.touches);
                        const scaleRatio = currentDistance / initialPinchDistance;
                        this.currentScale = Math.max(0.005, Math.min(0.05, initialScale * scaleRatio));
                        this.model.setAttribute('scale', {
                            x: this.currentScale,
                            y: this.currentScale,
                            z: this.currentScale
                        });
                    }
                });
                
                scene.addEventListener('touchend', () => {
                    isRotating = false;
                });
            },
            
            getTouchDistance: function(touches) {
                const dx = touches[0].clientX - touches[1].clientX;
                const dy = touches[0].clientY - touches[1].clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }
        });
        
        // åˆæœŸåŒ–
        window.addEventListener('load', function() {
            // ã‚«ãƒ¡ãƒ©ã«ãƒ‡ãƒã‚¤ã‚¹æ–¹å‘ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
            const camera = document.querySelector('[camera]');
            camera.setAttribute('device-orientation-controls', '');
            
            // ãƒ¢ãƒ‡ãƒ«ã«æ“ä½œæ©Ÿèƒ½ã‚’è¿½åŠ 
            const model = document.querySelector('#fixed-model');
            model.setAttribute('model-interaction', '');
            
            console.log('ğŸ¯ ç–‘ä¼¼6DoF AR æº–å‚™å®Œäº†');
            console.log('ğŸ“± ã€ŒARä½“é¨“ã‚’é–‹å§‹ã€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„');
        });
    </script>
    
    <style>
        body {
            font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Yu Gothic', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            background: #000;
        }
        
        button {
            touch-action: manipulation;
        }
        
        button:active {
            transform: scale(0.95);
        }
    </style>
</body>
</html>
